{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Lambda Function to tag the EC2 Instances.",
    "Parameters": {
        "FargateClusterName": {
            "Description": "Select the bucket name where the lambda function code resides",
            "Default": "SSMReport-Cluster",
            "Type": "String"
        },
        "SSMReportSchedule": {
            "Description": "How frequently you want to execute the lambda function, Refer here for help https://docs.aws.amazon.com/eventbridge/latest/userguide/scheduled-events.html",
            "Default": "rate(12 hours)",
            "Type": "String"
        },
      "SubnetIDS": {
            "Description": "List of Subnets with Public Internet Access",
            "Default": "subnet-1b5b6a51,subnet-8fefb780",
            "Type" : "List<AWS::EC2::Subnet::Id>"
        },
      "ECSTaskExecutionRole": {
            "Description": "ARN for ECS Task Exection",
            "Default": "arn:aws:iam::495830459543:role/ecsTaskExecutionRole",
            "Type": "String"
        },
      "SecurityGroups": {
            "Description": "Security Groups with TCP 80 Open for 0.0.0.0/0",
            "Default": "sg-07dc79e4c7cf94f80",
            "Type": "List<AWS::EC2::SecurityGroup::Id>"
        }
    },
    "Resources": {
      "AutomationServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "events.amazonaws.com",
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole"
                ],
                "Path": "/"
            }
        },
      "FargateCluster": {
        "Type" : "AWS::ECS::Cluster",
        "Properties" :
        {
          "ClusterName" : {
            "Ref": "FargateClusterName"
          }
        }
      },
      "TaskDef": {
        "Type" : "AWS::ECS::TaskDefinition",
        "Properties" : {
          "Cpu" : "256",
          "ContainerDefinitions" : [
            {
              "Image" : "satishnaidi/ssm-report:latest",
              "Name" : "SSMReportContainer",
              "Environment" : [
                {
                "Name" : "bucket_name",
                "Value" : "madhav-ssm-logs"
                }
              ]
            }
          ],
          "ExecutionRoleArn" : { "Ref": "ECSTaskExecutionRole"},
          "RequiresCompatibilities": ["FARGATE"],
          "Memory" : "512",
          "NetworkMode" : "awsvpc",
          "TaskRoleArn" : { "Ref": "ECSTaskExecutionRole"}
        }
      },
      "EventRule": {
        "Type" : "AWS::Events::Rule",
        "Properties" : {
          "Description" : "Just a Dummy",
          "Name" : "RuleName",
          "RoleArn" : "arn:aws:iam::495830459543:role/ecsEventsRole",
          "ScheduleExpression" : { "Ref": "SSMReportSchedule" },
          "State" : "ENABLED",
          "Targets" : [
            {
            "Arn": {
                  "Fn::GetAtt": [
                      "FargateCluster",
                      "Arn"
                  ]
              },
            "EcsParameters" : {
              "LaunchType" : "FARGATE",
              "NetworkConfiguration" : {
                "AwsVpcConfiguration" : {
                  "AssignPublicIp" : "DISABLED",
                  "SecurityGroups" : { "Ref": "SecurityGroups" },
                  "Subnets" : {"Ref": "SubnetIDS"}
                }
              },
              "TaskCount" : 1,
              "TaskDefinitionArn" : { "Ref": "TaskDef" }
            },
            "Id" : "Id123",
            "RoleArn" : "arn:aws:iam::495830459543:role/ecsTaskExecutionRole"
            }
          ]
        }
      }
    },
    "Outputs": {
        "EC2MasterLambda": {
            "Description": "Cluster created ",
            "Value": {
                "Ref": "FargateCluster"
            }
        }
    }
}